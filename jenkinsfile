pipeline {
  agent any
  environment {
    IMAGE_NAME = "DOCKERHUB_USER/hello-java"
  }
  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Build JAR') {
      steps { sh 'mvn -B -DskipTests package' }
    }

    stage('Build Image') {
      steps {
        script {
          IMAGE_TAG = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
          sh "docker build -t ${IMAGE_TAG} ."
        }
      }
    }

    stage('Push Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', passwordVariable: 'DOCKER_PSW', usernameVariable: 'DOCKER_USER')]) {
          sh '''
            echo "$DOCKER_PSW" | docker login -u "$DOCKER_USER" --password-stdin
            docker push ${IMAGE_TAG}
            docker logout
          '''
        }
      }
    }

    stage('Deploy to k8s') {
      steps {
        script {
          // Replace placeholder in k8s deployment with the pushed image and apply
          sh """
            sed 's|DOCKER_IMAGE_PLACEHOLDER|${IMAGE_TAG}|g' k8s/deployment.yaml > k8s/deployment-applied.yaml
            kubectl apply -f k8s/deployment-applied.yaml
            kubectl apply -f k8s/service.yaml
          """
        }
      }
    }
  }
}
