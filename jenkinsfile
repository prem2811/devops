pipeline {
  agent any
  environment {
    def IMAGE_NAME = "prem2811/hello-java"
  }
  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Build JAR') {
      steps { sh 'mvn -B -DskipTests package' }
    }

    stage('Build Image') {
      steps {
        script {
          IMAGE_TAG = "${IMAGE_NAME}:${env.BUILD_NUMBER}"
          sh "docker build -t ${IMAGE_TAG} ."
        }
      }
    }

    stage('Push Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', passwordVariable: 'DOCKER_PSW', usernameVariable: 'DOCKER_USER')]) {
          script {
                // Define image name and tag
                def IMAGE_NAME = "prem2811/hello-java"
                def IMAGE_TAG = "16" // or use a dynamic tag, e.g., BUILD_NUMBER
                
                sh 'echo "Logging into Docker Hub..."'
                sh 'docker login -u $DOCKER_USER -p $DOCKER_PSW'
                
                // Push the image
                sh "docker push ${IMAGE_NAME}:${IMAGE_TAG}"
            }
        }
      }
    }

    stage('Deploy to k8s') {
      steps {
        script {
          // Replace placeholder in k8s deployment with the pushed image and apply
          sh """
            sed 's|DOCKER_IMAGE_PLACEHOLDER|${IMAGE_TAG}|g' k8s/deployment.yaml > k8s/deployment-applied.yaml
            kubectl apply -f k8s/deployment-applied.yaml
            kubectl apply -f k8s/service.yaml
          """
        }
      }
    }
  }
}
